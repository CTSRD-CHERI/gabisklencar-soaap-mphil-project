/*
 * RUN: clang %cflags -emit-llvm -S %s -o %t.ll
 * RUN: soaap --soaap-sandbox-platform=capsicum -o %t.soaap.ll %t.ll > %t.out
 * RUN: FileCheck %s -input-file %t.out
 *
 * CHECK: Running Soaap Pass
 */
#include "soaap.h"

void foo() {
  // CHECK: Another vulnerability here would not grant ambient authority to the attacker but would leak the following restricted rights:
  // CHECK-NEXT: Possible trace ([sandbox]):
  // CHECK-NEXT: h ({{.*}})
  // CHECK-NEXT: g ({{.*}})
  // CHECK-NEXT: f ({{.*}})
  // CHECK-NEXT: e ({{.*}})
  // CHECK-NEXT: d ({{.*}})
  // CHECK-NEXT: c ({{.*}})
  // CHECK-NEXT: b ({{.*}})
  // CHECK-NEXT: a ({{.*}})
  // CHECK-NEXT: main ({{.*}})

  __soaap_vuln_pt("CVE-100-100");
  __soaap_vuln_pt("CVE-100-101");
}

void h() {
  foo();
}

void g() {
  h();
}

void f() {
  g();
}

void e() {
  f();
}

void d() {
  e();
}

void c() {
  d();
}

void b() {
  c();
}

void a() {
  __soaap_sandboxed_region_start("sandbox");
  b();
  __soaap_sandboxed_region_end("sandbox");
}


int main(int argc, char** argv) {
  a();
}
